<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Localizador de Tiendas</title>
<style>
  :root{
    --brand:#004F8A;
    --brand-600:#004F8A;
    --text:#000000;
    --muted:#368ED0;
    --border:#e2e8f0;
    --bg:#fff;
    --radius:14px;
    --shadow:0 10px 30px rgba(2,6,23,.08)
  }
  html,body{height:100%}
  body{
    margin:0;display:grid;place-items:center;padding:24px;
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    color:var(--text);background:var(--bg)
  }
  .wrap{width:100%;max-width:680px;text-align:center}
  h1{margin:0 0 8px;font-size:clamp(32px,5vw,56px);line-height:1.05;letter-spacing:-.5px}
  .sub{margin:0 auto 32px;color:var(--muted);font-size:clamp(14px,2.2vw,18px);max-width:52ch}
  .card{background:#fff;border:1px solid var(--border);border-radius:22px;padding:clamp(16px,3.2vw,28px);box-shadow:var(--shadow)}
  .field{text-align:left;margin-bottom:14px}
  label{display:block;font-size:13px;color:var(--muted);margin:0 0 6px}
  select{
    width:100%;box-sizing:border-box;font-size:16px;padding:14px 16px;border:1px solid var(--border);
    border-radius:14px;background:#fff;transition:box-shadow .15s,border-color .15s,background-color .15s;appearance:none;
    background-image:linear-gradient(45deg,transparent 50%,#94a3b8 50%),linear-gradient(135deg,#94a3b8 50%,transparent 50%);
    background-position:calc(100% - 22px) calc(1em + 2px), calc(100% - 16px) calc(1em + 2px);
    background-size:6px 6px,6px 6px;background-repeat:no-repeat
  }
  select:focus{border-color:#94a3b8;box-shadow:0 0 0 4px rgba(148,163,184,.20)}
  select:disabled{background:#f8fafc;color:#94a3b8;cursor:not-allowed}
  .actions{margin-top:10px}
  button{
    width:100%;font-size:18px;font-weight:600;padding:16px 20px;background:var(--brand);color:#fff;border:0;border-radius:999px;cursor:pointer;
    transition:transform .06s, background .15s, box-shadow .15s; box-shadow:0 6px 18px rgba(12,74,110,.25)
  }
  button:hover{background:var(--brand-600)}
  button:active{transform:translateY(1px)}
  button:disabled{background:#cbd5e1;box-shadow:none;cursor:not-allowed}
  .hint{margin-top:10px;color:var(--muted);font-size:13px;min-height:1.2em;text-align:left}

  /* ✅ New style for "Localizar tienda" button */
  .locatorbutton{
    display:inline-block;
    font-size:14px;
    font-weight:600;
    padding:10px 16px;
    margin-top:6px;
    background:var(--brand);
    color:#fff;
    border-radius:999px;
    text-decoration:none;
    transition:transform .06s ease, background .15s ease, box-shadow .15s ease;
    box-shadow:0 3px 10px rgba(12,74,110,.25);
  }
  .locatorbutton:hover{background:var(--brand-600)}
  .locatorbutton:active{transform:translateY(1px)}

  /* Spinner + results */
  #spinner{display:none;margin:16px auto;width:28px;height:28px;border:3px solid #e2e8f0;border-top-color:#0c4a6e;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  #myData{margin-top:18px;text-align:left}
  #myData .store{padding:12px 0;border-bottom:1px solid var(--border)}
  #myData .store a{display:inline-block;margin-top:6px}
</style>
</head>
<body>
  <main class="wrap">
    <h1>Localizador de Tiendas</h1>
    <p class="sub">Encuentra tu producto GOYA favorito fácilmente.</p>

    <section class="card" aria-label="Formulario de búsqueda de productos">
      <div class="field">
        <label for="cat">Categoría</label>
        <select id="cat" disabled>
          <option>Cargando…</option>
        </select>
      </div>

      <div class="field">
        <label for="prod">Producto</label>
        <select id="prod" disabled>
          <option value="">Selecciona una categoría…</option>
        </select>
        <div id="hint" class="hint" aria-live="polite"></div>
      </div>

      <div class="actions">
        <button id="buscar" disabled>Buscar</button>
        <div id="spinner" aria-hidden="true"></div>
      </div>
    </section>

    <!-- Results -->
    <div id="myData"></div>
  </main>

  <script>
    // --- Load catalog from GitHub Raw (fresh) ---
    const RAW_BASE = "https://raw.githubusercontent.com/goyapr/product-locator/refs/heads/main/locator.json";
    const JSON_URL = `${RAW_BASE}?t=${Date.now()}`; // cache-buster

    const $cat  = document.getElementById("cat");
    const $prod = document.getElementById("prod");
    const $hint = document.getElementById("hint");
    const $go   = document.getElementById("buscar");
    const $spinner = document.getElementById("spinner");
    const $results = document.getElementById("myData");

    const opt = (v,t) => { const o=document.createElement("option"); o.value=String(v??""); o.textContent=String(t??v??""); return o; };

    async function getCatalog(){
      const res = await fetch(JSON_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    (async function init(){
      let data;
      try { data = await getCatalog(); }
      catch (e) {
        console.error(e);
        $cat.innerHTML = ""; $cat.append(opt("", "No se pudo cargar el catálogo"));
        $hint.textContent = "Revisa el enlace del JSON o la estructura.";
        return;
      }

      const categories = Array.isArray(data.categories) ? data.categories : [];
      const byCategory = data.byCategory || {};

      // Populate categories
      $cat.innerHTML = "";
      $cat.append(opt("", "Selecciona una categoría…"));
      for (const c of categories) $cat.append(opt(c.value, c.label));
      $cat.disabled = false;

      // When category changes, populate products (use labelWithWeight)
      $cat.addEventListener("change", () => {
        const slug = $cat.value;
        const list = Array.isArray(byCategory[slug]) ? byCategory[slug] : [];

        $prod.innerHTML = "";
        if (!slug){
          $prod.append(opt("", "Selecciona una categoría…"));
          $prod.disabled = true; $go.disabled = true; $hint.textContent = "";
          return;
        }
        if (!list.length){
          $prod.append(opt("", "No hay productos en esta categoría"));
          $prod.disabled = true; $go.disabled = true; $hint.textContent = "";
          return;
        }

        $prod.append(opt("", "Selecciona un producto…"));
        for (const p of list){
          // value = SKU, text = labelWithWeight (fallback label)
          const text = p.labelWithWeight || p.label || p.value;
          $prod.append(opt(p.value, text));
        }
        $prod.disabled = false; $go.disabled = true;

        const catLabel = $cat.options[$cat.selectedIndex].textContent;
        $hint.textContent = `Se cargaron ${list.length} producto${list.length===1?"":"s"} para “${catLabel}”.`;
      });

      // Enable the button when a product is selected
      $prod.addEventListener("change", () => { $go.disabled = !$prod.value; });

      // Wire the button to geolocation + API lookup
      $go.addEventListener("click", (e) => {
        e.preventDefault();
        getLocation(); // <--- call your flow
      });
    })();

    // --------------------------
    // Geolocation + API workflow
    // --------------------------

    const getLocation = () => {
      const sku = document.getElementById("prod")?.value || "";

      if (!sku) {
        alert("Selecciona un producto primero.");
        return;
      }

      // Clear previous results
      if ($results) $results.innerHTML = "";

      // Show spinner
      if ($spinner) $spinner.style.display = "block";

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => showPosition(pos, sku),
          () => {
            if ($spinner) $spinner.style.display = "none";
            alert("Habilite la opción de geolocalización para poder usar la función de localizar productos.");
          },
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      } else {
        if ($spinner) $spinner.style.display = "none";
        alert("Geolocation is not supported by this browser.");
      }
    };

    // Build API URL and fetch
    const showPosition = (position, sku) => {
      const lat = position.coords.latitude;
      const long = position.coords.longitude;
      const baseURL = "https://portal.goya.com/goyaapi/pr/productdistance";
      const miles = 2.5; // adjust if needed

      // API expects: /{sku}/{miles}/{long}/{lat}/
      const locationUrl = `${baseURL}/${encodeURIComponent(sku)}/${miles}/${long}/${lat}/`;
      console.log("[Locator] URL:", locationUrl);

      return fetch(locationUrl)
        .then((response) => {
          if ($spinner) $spinner.style.display = "none";
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return response.json();
        })
        .then((data) => {
          appendData(Array.isArray(data) ? data : []);
        })
        .catch((err) => {
          console.error("Locator error:", err);
          alert("Ocurrió un error obteniendo las tiendas. Intente nuevamente.");
        });
    };

    const appendData = (data) => {
      const mainContainer = document.getElementById("myData");
      if (!mainContainer) return;

      if (data.length === 0) {
        const div = document.createElement("div");
        div.innerHTML = `
          <div style="text-align:center">
            <strong class="AuthLocation">No hubo resultados.</strong>
          </div>`;
        mainContainer.appendChild(div);
        return;
      }

      // Sort by distance ascending
      data.sort((a, b) => {
        const da = Number(a.distance ?? Infinity);
        const db = Number(b.distance ?? Infinity);
        return da - db;
      });

      data.forEach((i) => {
        const div = document.createElement("div");
        div.className = "store";
        div.innerHTML =
          "<strong>NOMBRE: </strong>" + (i.name ?? "") + "<br />" +
          "<strong>DIRECCIÓN: </strong>" + (i.adreS1 ?? "") + "<br />" +
          (i.adreS2 ?? "") + "<br />" +
          "<strong>CIUDAD: </strong>" + (i.city ?? "") + "<br />" +
          "<strong>ESTADO: </strong>" + (i.state ?? "") + "<br />" +
          "<strong>ZIPCODE: </strong>" + (i.zipcod ?? "") + "<br />" +
          "<strong>DISTANCIA EN MILLAS: </strong>" + (i.distance ?? "") + "<br /><br />" +
          "<a class='locatorbutton button' target='_blank' href='https://www.google.com/maps/@" +
          (i.latitu ?? "") + "," + (i.longit ?? "") + ",19.22z'>Localizar tienda</a>";
        mainContainer.appendChild(div);
      });
    };
  </script>
</body>
</html>
