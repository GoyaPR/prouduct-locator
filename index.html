<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Localizador de Tiendas</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; padding: 24px; }
    label { display:block; margin: 12px 0 6px; }
    select { width: 320px; max-width: 100%; padding: 6px; }
    .hint { color: #666; font-size: 0.9rem; margin-top: 6px; }
  </style>
</head>
<body>
  <h1>Cascading Menu</h1>

  <label for="cat">Category</label>
  <select id="cat" disabled>
    <option>Loading…</option>
  </select>

  <label for="prod">Product</label>
  <select id="prod" disabled>
    <option value="">Choose a category first…</option>
  </select>

  <div id="hint" class="hint"></div>

  <script>
    const JSON_URL = "https://cdn.jsdelivr.net/gh/goyapr/product-locator/locator.json";

    const $cat  = document.getElementById("cat");
    const $prod = document.getElementById("prod");
    const $hint = document.getElementById("hint");

    // Helpers
    const opt = (v, t) => {
      const o = document.createElement("option");
      o.value = String(v ?? "");
      o.textContent = String(t ?? v ?? "");
      return o;
    };

    function normalizeData(raw) {
      // Case A: UI-optimized: { categories:[{value,label}], byCategory:{slug:[{value,label}]}}
      if (raw && Array.isArray(raw.categories) && raw.byCategory && typeof raw.byCategory === "object") {
        return {
          categories: raw.categories.map(c => ({ slug: c.value, name: c.label })),
          productsByCat: Object.fromEntries(
            Object.entries(raw.byCategory).map(([slug, list]) => [
              slug,
              (list || []).map(p => ({ slug: p.value, name: p.label, category: slug }))
            ])
          )
        };
      }

      // Case B: Normalized: { categories:[{slug,name}], products:[{slug,name,category}] }
      if (raw && Array.isArray(raw.categories) && Array.isArray(raw.products)) {
        const byCat = {};
        for (const p of raw.products) {
          const cat = String(p.category ?? "").trim();
          if (!cat) continue;
          (byCat[cat] ||= []).push({
            slug: String(p.slug ?? ""),
            name: String(p.name ?? ""),
            category: cat
          });
        }
        // Optional: sort
        for (const k of Object.keys(byCat)) {
          byCat[k].sort((a,b) => a.name.localeCompare(b.name));
        }
        const cats = raw.categories
          .map(c => ({ slug: String(c.slug ?? ""), name: String(c.name ?? c.slug ?? "") }))
          .sort((a,b) => a.name.localeCompare(b.name));
        return { categories: cats, productsByCat: byCat };
      }

      throw new Error("Unsupported JSON structure. Expect UI or normalized shape.");
    }

    async function main() {
      try {
        const res = await fetch(JSON_URL, { cache: "no-cache" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const raw = await res.json();
        const data = normalizeData(raw);

        // Populate categories
        $cat.innerHTML = "";
        $cat.append(opt("", "Choose a category…"));
        for (const c of data.categories) $cat.append(opt(c.slug, c.name));
        $cat.disabled = false;

        // Handle category change
        $cat.addEventListener("change", () => {
          const slug = $cat.value;
          const list = data.productsByCat[slug] || [];
          $prod.innerHTML = "";
          if (!slug) {
            $prod.append(opt("", "Choose a category first…"));
            $prod.disabled = true;
            $hint.textContent = "";
            return;
          }
          if (!list.length) {
            $prod.append(opt("", "No products in this category"));
            $prod.disabled = true;
            $hint.textContent = "";
            return;
          }
          $prod.append(opt("", "Choose a product…"));
          for (const p of list) $prod.append(opt(p.slug, p.name));
          $prod.disabled = false;
          $hint.textContent = `Loaded ${list.length} product${list.length === 1 ? "" : "s"} for “${$cat.options[$cat.selectedIndex].textContent}”.`;
        });
      } catch (err) {
        console.error(err);
        $cat.innerHTML = "";
        $cat.append(opt("", "Failed to load data"));
        $hint.textContent = "Couldn’t fetch or parse the JSON. Check the URL and structure.";
      }
    }

    main();
  </script>
</body>
</html>
